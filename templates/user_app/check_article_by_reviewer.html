{% extends 'user_app/base.html' %}
{% load i18n %}
{% load static %}
{% block title %}{% trans "Maqola tekshirish" %}{% endblock %}
{% block content %}
    <div id="content" class="content">

        <h2 class="page-header viewArticleFont">
            {% trans "Maqola tekshirish" %}
        </h2>

        <div>
            <div class="panel-body" style="padding:10px;">
                <div class="row jumbotron forshadow" style="background-color: #FFFFFF; font-size: 15px;">
                    <div class="col-md-2">
                        <div class="card">
							<img class="card-img-top" src="{{ editor.user.avatar.url }}" width="10" alt="Card image cap" />
							<div class="card-body">
								<h5 class="card-title">{{ editor.user.full_name }}</h5>
								<p class="card-text f-s-13">Bosh Muharrir</p>
								<p class="card-text text-gray f-s-13">{{ notifification.created_at }}</p>
							</div>
						</div>
                    </div>
                    <div class="col-md-10">
                        <table style="margin-left: 3%;">
                            <tr>
                                <td><p><b>{% trans "Mavzu:" %} </b>{{ article.title|safe }}</p></td>
                            </tr>
                        
                            <tr>
                                <td><p></p><b>{% trans "Abstract:" %} </b>{{ article.abstract|safe }}</td>
                            </tr>
                            <tr>
                                <td><b>{% trans "Kalit so'zlar:" %} </b>{{ article.keywords|safe }}</td>
                            </tr>
                            <br>
                            <tr>
                                <td><b>{% trans "MS word fayl:" %} </b><a class="btn btn-outline-info btn-sm"
                                                                          href="{{ article_file.file.url }}"
                                                                          download
                                                                          role="button"><span>{% trans "Yuklab olish" %}</span></a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div> 

                <div class="row d-flex justify-content-center">
                    <button type="button" data-id="{{ article.id }}" id="view-article-messages-by-reviewer" class="btn btn-md btn-info forshadow">
                        <i class="fa fa-comment"></i>  LOAD MESSAGES</button>
                </div>
                <br>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="col-lg-12 col-lg-6" style="display: none;" id="MessageBoxReviewer1">
                            <!-- begin widget-chat -->
                            <div class="m-b-10 m-t-10 f-s-12">
                                <h5 class="text-inverse">Author</h5>
                            </div>
                
                            <div class="widget-chat widget-chat-rounded m-b-30 forshadow" data-id="widget">
                
                                <!-- begin widget-chat-header -->
                                <div class="widget-chat-header">
                                    <div class="widget-chat-header-icon">
                                        <i class="fa fa-book width-30 height-30 f-s-20 bg-yellow text-inverse text-center rounded-corner"
                                           style="line-height: 30px"></i>
                                    </div>
                                    <div class="widget-chat-header-content">
                                        <h4 class="widget-chat-header-title">Sending Message To Author</h4>
                                    </div>
                                    <div class="widget-chat-header-content">
                                        <button type="button" data-id="{{ article.id }}" class="btn btn-sm btn-info reviewerWrite-message-btn1" style="float:right;">SEND MESSAGE</button>
                                    </div>
                                </div>
                                <!-- end widget-chat-header -->
                
                                <!-- begin widget-chat-body -->
                                <div class="widget-chat-body" data-scrollbar="true" data-height="250px" id="reviewer_chat_body1">
                
                
                                </div>
                                <!-- end widget-chat-body -->
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="col-lg-12 col-lg-6" style="display: none;" id="MessageBoxReviewer2">
                            <!-- begin widget-chat -->
                            <div class="m-b-10 m-t-10 f-s-12">
                                <h5 class="text-inverse">Reviewers</h5>
                            </div>
                
                            <div class="widget-chat widget-chat-rounded m-b-30 forshadow" data-id="widget">
                
                                <!-- begin widget-chat-header -->
                                <div class="widget-chat-header">
                                    <div class="widget-chat-header-icon">
                                        <i class="fa fa-book width-30 height-30 f-s-20 bg-yellow text-inverse text-center rounded-corner"
                                           style="line-height: 30px"></i>
                                    </div>
                                    <div class="widget-chat-header-content">
                                        <h4 class="widget-chat-header-title">Sending Message To Reviewer</h4>
                                    </div>
                                    <div class="widget-chat-header-content">
                                        <button type="button" data-id="{{ article.id }}" class="btn btn-sm btn-info reviewerWrite-message-btn2" style="float:right;">SEND MESSAGE</button>
                                    </div>
                                </div>
                                <!-- end widget-chat-header -->
                
                                <!-- begin widget-chat-body -->
                                <div class="widget-chat-body" data-scrollbar="true" data-height="250px" id="reviewer_chat_body2">
                
                
                                </div>
                                <!-- end widget-chat-body -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="writereviewer_message_div"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
        $('body').on('click', '#view-article-messages-by-reviewer', function(e){
            e.preventDefault();
            
            let id = $(this).data('id');
        
                    $.ajax({
                        type: "GET",
                        url: "/profile/article_notification/view/" + id + "/",
                        success: function (response) {
                            console.log(response);
                            $('#MessageBoxReviewer1').css('display', 'block');
                            $('#reviewer_chat_body1').empty();
        
                           for(let item of response.notifications){
        
                            let time_tz = new Date(item.created_at);
                            let time_string = time_tz.toLocaleString();
                            console.log(time_string);
        
                                if(response.current_user_id === item.from_user__id){
        
                                    let temp1 = `<div class="widget-chat-item right"><div class="widget-chat-info"><div class="widget-chat-info-container"><div class="widget-chat-name text-indigo">`
                                         + item.from_user__email + 
                                         `</div><div class="widget-chat-message">` 
                                            + item.message + 
                                            `</div><div class="widget-chat-time">` 
                                                + time_string + 
                                                `</div></div></div></div>`;
        
                                    $('#reviewer_chat_body1').append(temp1); 
                                }
        
                                if(response.current_user_id === item.to_user__id){
        
                                    let temp2 = `<div class="widget-chat-item left"><div class="widget-chat-info"><div class="widget-chat-info-container"><div class="widget-chat-name text-indigo">` + item.from_user__email + `</div><div class="widget-chat-message">` + item.message + `</div><div class="widget-chat-time">` + time_string + `</div></div></div></div>`;
                                    $('#reviewer_chat_body2').append(temp2); 
                                }
                            }
                        
                        },
                        error: function (response) {
                            console.log(response);
                        }
                    });

                    $.ajax({
                        type: "GET",
                        url: "/profile/comment_editor_vs_reviewer/" + id + "/",
                        success: function (response) {
                            console.log(response);
                            $('#MessageBoxReviewer2').css('display', 'block');
                            $('#reviewer_chat_body2').empty();
        
                            if(response.is_visible_comment){
                                for(let item of response.notifications){
        
                                    let time_tz = new Date(item.created_at);
                                    let time_string = time_tz.toLocaleString();
                                    console.log(time_string);
                
                                        if(response.current_user_id === item.from_user__id){
                
                                            let temp1 = `<div class="widget-chat-item right"><div class="widget-chat-info"><div class="widget-chat-info-container"><div class="widget-chat-name text-indigo">`
                                                 + item.from_user__email + 
                                                 `</div><div class="widget-chat-message">` 
                                                    + item.message + 
                                                    `</div><div class="widget-chat-time">` 
                                                        + time_string + 
                                                        `</div></div></div></div>`;
                
                                            $('#reviewer_chat_body2').append(temp1); 
                                        }
                
                                        if(response.current_user_id === item.to_user__id){
                
                                            let temp2 = `<div class="widget-chat-item left"><div class="widget-chat-info"><div class="widget-chat-info-container"><div class="widget-chat-name text-indigo">` + item.from_user__email + `</div><div class="widget-chat-message">` + item.message + `</div><div class="widget-chat-time">` + time_string + `</div></div></div></div>`;
                                            $('#reviewer_chat_body2').append(temp2); 
                                        }
                                    }
                            } else {
                                $('#reviewer_chat_body2').append("<h3 class='text-danger'>" + response.message + "</h3>");
                            }
                        
                        },
                        error: function (response) {
                            console.log(response);
                        }
                    });

        });

        $('body').on('click', '.reviewerWrite-message-btn1', function (e) {
            e.preventDefault();
    
            let id = $(this).data('id');

            $.ajax({
                type: 'GET',
                url: "/send_message/" + id + "/",
                success: function (response) {
                    $('#writereviewer_message_div').html(response);
                    $('#send-message-modal').modal('show');
                },
                error: function (error) {
                    console.log("Xatolik");
                    console.log(error);
                }
            });
        });

        $('body').on('click', '.reviewerWrite-message-btn2', function (e) {
            e.preventDefault();
    
            let id = $(this).data('id');

            $.ajax({
                type: 'GET',
                url: "/send_message/" + id + "/",
                success: function (response) {
                    $('#writereviewer_message_div').html(response);
                    $('#send-message-modal').modal('show');
                },
                error: function (error) {
                    console.log("Xatolik");
                    console.log(error);
                }
            });
        });
    </script>
{% endblock %}