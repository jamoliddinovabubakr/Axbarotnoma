{% extends 'user_app/base.html' %}
{% load i18n %}
{% load static %}
{% block title %}{% trans "Maqola tekshirish" %}{% endblock %}
{% block content %}
    <div id="content" class="content">
        <h2 class="page-header viewArticleFont">
            {% trans "Maqola tekshirish" %}
        </h2>
        <div>
            <div class="panel-body" style="padding:10px;">
                <div class="row jumbotron forshadow" style="background-color: #FFFFFF; font-size: 15px;">
                    <div class="col-md-2">
                        <div class="card">
							<img class="card-img-top" src="{{ editor.user.avatar.url }}" width="10" alt="Card image cap" />
							<div class="card-body">
								<h5 class="card-title">{{ editor.user.full_name }}</h5>
								<p class="card-text f-s-13">Bosh Muharrir</p>
								<p class="card-text text-gray f-s-13">{{ notifification.created_at }}</p>
							</div>
						</div>
                    </div>
                    <div class="col-md-10">
                        <table style="margin-left: 3%;">
                            <tr>
                                <td><p><b>{% trans "Mavzu:" %} </b>{{ article.title|safe }}</p></td>
                            </tr>
                        
                            <tr>
                                <td><p></p><b>{% trans "Abstract:" %} </b>{{ article.abstract|safe }}</td>
                            </tr>
                            <tr>
                                <td><b>{% trans "Kalit so'zlar:" %} </b>{{ article.keywords|safe }}</td>
                            </tr>
                            <br>
                            <tr>
                                <td><b>{% trans "MS word fayl:" %} </b><a class="btn btn-outline-info btn-sm"
                                                                          href="{{ article_file.file.url }}"
                                                                          download
                                                                          role="button"><span>{% trans "Yuklab olish" %}</span></a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div> 

                <div class="row d-flex justify-content-center">
                    <button type="button" data-id="{{ article.id }}" id="view-article-messages-by-reviewer" class="btn btn-md btn-info forshadow">
                        <i class="fa fa-comment"></i>  LOAD COMMENTS</button>
                </div>
                <br>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="col-lg-12 col-lg-6" style="display: none;" id="MessageBoxReviewer">
                            <!-- begin widget-chat -->
                            <div class="m-b-10 m-t-10 f-s-12">
                                <h5 class="text-inverse">Comments</h5>
                            </div>
                
                            <div class="widget-chat widget-chat-rounded m-b-30 forshadow" data-id="widget">
                
                                <!-- begin widget-chat-header -->
                                <div class="widget-chat-header">
                                    <div class="widget-chat-header-icon">
                                        <i class="fa fa-book width-30 height-30 f-s-20 bg-yellow text-inverse text-center rounded-corner"
                                           style="line-height: 30px"></i>
                                    </div>
                                    <div class="widget-chat-header-content">
                                        <h4 class="widget-chat-header-title">Sending Comment To Author and Editor</h4>
                                    </div>
                                </div>
                                <!-- end widget-chat-header -->
                
                                <!-- begin widget-chat-body -->
                                <div class="widget-chat-body" data-scrollbar="true" data-height="250px" id="reviewer_chat_body">
                
                
                                </div>
                                <!-- end widget-chat-body -->
                            </div>
                        </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-lg-12 col-lg-6">
                        <div class="card forshadow">
                            <ul style="margin: 2%;">
                                <li><b>Title: </b> {{ article_review.article.title }}</li>
                                <li><b>Editor: </b> {{ article_review.editor.user.full_name }}</li>
                                <li><b>Reviewer: </b> {{ article_review.reviewer.user.full_name }}</li>
                                <li><b>Status: </b> <span {% if article_review.status.id == 1 %} class='badge badge-warning' {% elif article_review.status.id == 2 %} 
                                    class='badge badge-info' {% elif article_review.status.id == 3 %} class='badge badge-success' {% elif article_review.status.id == 4 %} 
                                    class='badge badge-danger' {% elif article_review.status.id == 5 %} class='badge badge-indigo' {% endif %}>
                                    {{ article_review.status.name }}
                                </span></li>
                                <li><b>Date: </b> {{ article_review.created_at }}</li>
                             </ul> 
                             <br>
                                <form method="post" action="" class="sending_editor_form">
                                    {% csrf_token %}
                                    <table class="table table-striped table-td-valign-middle">
                                        <tbody>
                                        <tr>
                                            <td class="text-nowrap">
                                                <label for="review_article_id"></label><input type="text" value="{{ article_review.id }}" class="form-control" name="review_article_id" id="review_article_id" hidden/>
                                                <label for="notif_id"></label><input type="text" value="{{ notifification.id }}" class="form-control" name="notif_id" id="notif_id" hidden/>
                                                <label for="exampleFormControlTextarea1" class="form-label"><b>Taqriz</b></label>
                                                <label for="id_comment"></label><textarea class="form-control" name="comment" id="id_comment" rows="3" placeholder="Enter Result"></textarea>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </form>
                                <br>
                            <br>
                            <div class="row d-flex justify-content-center">
                                <button type="button" class="btn btn-danger forshadow" id="reject_reviewer_btn" style="margin-right: 1%;" disabled>Reject</button> 
                                <button type="button" class="btn btn-warning forshadow" id="resubmit_reviewer_btn" style="margin-right: 1%;" disabled>Resubmit</button> 
                                <button type="button" class="btn btn-success forshadow" id="confirm_reviewer_btn" disabled>Confirm</button>
                            </div> 
                            <br>
                        </div>           
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="writereviewer_message_div"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">

        $('#id_comment').keyup(function(e){
            e.preventDefault();
            let val = $(this).val();
            let is_checked = {{ article_review.result }};

            if(val.length > 0 && is_checked === 0 ){
                    $('#reject_reviewer_btn').prop("disabled", false);
                    $('#resubmit_reviewer_btn').prop("disabled", false);
                    $('#confirm_reviewer_btn').prop("disabled", false);
            } else {
                $('#reject_reviewer_btn').prop("disabled", true);
                $('#confirm_reviewer_btn').prop("disabled", true);
                $('#resubmit_reviewer_btn').prop("disabled", true);
            }
           
        });


        $('body').on('click', '#resubmit_reviewer_btn', function (e) {
            e.preventDefault();
            const $myForm = $('.sending_editor_form');
            const $formData = $myForm.serialize();

            let comment = $('#id_comment').val();

            $.ajax({
                type : "POST", 
                url: "/profile/reviewer_resubmit/",
                data: $formData,
                success: function(response){
                    console.log(response.message);
                    window.location.reload();
                },
                error: function(error){
                    console.log("Error");
                }
            });
        });


        $('body').on('click', '#reject_reviewer_btn', function (e) {
            e.preventDefault();
            const $myForm = $('.sending_editor_form');
            const $formData = $myForm.serialize();

            let comment = $('#id_comment').val();

            $.ajax({
                type : "POST", 
                url: "/profile/reviewer_rejected/",
                data: $formData,
                success: function(response){
                    console.log(response.message);
                    window.location.reload();
                },
                error: function(error){
                    console.log("Error");
                }
            });
        });



        $('body').on('click', '#confirm_reviewer_btn', function (e) {
            e.preventDefault();
            const $myForm = $('.sending_editor_form');
            const $formData = $myForm.serialize();

            let comment = $('#id_comment').val();

            $.ajax({
                type : "POST", 
                url: "/profile/reviewer_confirmed/",
                data: $formData,
                success: function(response){
                    console.log(response.message);
                    window.location.reload();
                },
                error: function(error){
                    console.log("Error");
                }
            });
        });


        $('body').on('click', '#view-article-messages-by-reviewer', function(e){
            e.preventDefault();
            
            let id = $(this).data('id');
        
                    $.ajax({
                        type: "GET",
                        url: "/profile/article_notification/view/" + id + "/",
                        success: function (response) {
                            console.log(response);
                            $('#MessageBoxReviewer').css('display', 'block');
                            $('#reviewer_chat_body').empty();
        
                           for(let item of response.notifications){
        
                            let time_tz = new Date(item.created_at);
                            let time_string = time_tz.toLocaleString();
                            console.log(time_string);
        
                                if(response.current_user_id === item.from_user__id){
        
                                    let temp1 = `<div class="widget-chat-item right"><div class="widget-chat-info"><div class="widget-chat-info-container"><div class="widget-chat-name text-indigo">`
                                         + item.from_user__email + 
                                         `</div><div class="widget-chat-message">` 
                                            + item.message + 
                                            `</div><div class="widget-chat-time">` + `</div></div></div></div>`;
        
                                    $('#reviewer_chat_body').append(temp1); 
                                }
        
                                if(response.current_user_id === item.to_user__id){
        
                                    let temp2 = `<div class="widget-chat-item left">
                                        <div class="widget-chat-info">
                                            <div class="widget-chat-info-container">
                                                <div class="widget-chat-name text-indigo">`
                                                     + item.from_user__email + 
                                                     `</div><div class="widget-chat-message">`
                                                         + item.message + 
                                                         `</div><div class="widget-chat-time">`+ `</div>
                                                         <br><div class="widget-chat-ansewer">
                                                            <button type="button" data-id="${id},${item.from_user__id}" class="btn btn-white btn-sm reviewerWrite-message-btn">Ansewer</button>
                                                        </div>
                                                        </div></div></div>`;
                                    $('#reviewer_chat_body').append(temp2); 
                                }
                            }
                        
                        },
                        error: function (response) {
                            console.log(response);
                        }
                    });

        });


        $('body').on('click', '.reviewerWrite-message-btn', function (e) {
            e.preventDefault();
    
            const data = $(this).data('id');
            const array = data.split(',');
            const id = array[0];
            const user_id = parseInt(array[1]);

            $.ajax({
                type: 'GET',
                url: "/send_message/" + id + "/" + user_id,
                success: function (response) {
                    $('#writereviewer_message_div').html(response);
                    $('#send-message-modal').modal('show');
                },
                error: function (error) {
                    console.log("Xatolik");
                    console.log(error);
                }
            });
        });

    </script>
{% endblock %}