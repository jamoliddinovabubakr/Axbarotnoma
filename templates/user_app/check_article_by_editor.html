{% extends 'user_app/base.html' %}
{% load i18n %}
{% load static %}
{% block title %}{% trans "Maqola tekshirish" %}{% endblock %}
{% block content %}
    <div id="content" class="content">

        <h2 class="page-header viewArticleFont">
            {% trans "Maqola tekshirish" %}
        </h2>

        <div>
            <div class="panel-body" style="padding:10px;">
                <div class="row jumbotron forshadow" style="background-color: #FFFFFF; font-size: 15px;">
                    <div class="col-md-2">
                    </div>
                    <div class="col-md-8">
                        <table>
                            <tr>
                                <td><p><b>{% trans "Title:" %} </b>{{ article.title|safe }}</p></td>
                            </tr>
                            <tr>
                                <td>
                                    <b>{% trans "Author:" %} </b>{{ article.author.last_name }} {{ article.author.first_name }}
                                    <br><i>{{ article.author.email }}</i></td>
                            </tr>
                            <tr>
                                <td><p></p><b>{% trans "Abstract:" %} </b>{{ article.abstract|safe }}</td>
                            </tr>
                            <tr>
                                <td><b>{% trans "Keywords:" %} </b>{{ article.keywords|safe }}</td>
                            </tr>
                            <br>
                            <tr>
                                <td><b>{% trans "File:" %} </b><a class="btn btn-outline-info btn-sm"
                                                                  href="{{ article_file.file.url }}"
                                                                  download
                                                                  role="button"><i
                                        class="icon-paper-clip"></i><span> {% trans "Download File" %}</span></a>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-2"></div>
                </div>

                <div class="row d-flex justify-content-center">
                    <button type="button" data-id="{{ article.id }}" id="view-article-messages"
                            class="btn btn-md btn-info forshadow">
                        <i class="fa fa-comment"></i> LOAD COMMENTS
                    </button>
                </div>
                <br>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="col-lg-12 col-lg-6" style="display: none;" id="MessageBoxEditor">
                            <!-- begin widget-chat -->
                            <div class="m-b-10 m-t-10 f-s-12">
                                <h5 class="text-inverse">Comments</h5>
                            </div>

                            <div class="widget-chat widget-chat-rounded m-b-30 forshadow" data-id="widget">

                                <!-- begin widget-chat-header -->
                                <div class="widget-chat-header">
                                    <div class="widget-chat-header-icon">
                                        <i class="fa fa-book width-30 height-30 f-s-20 bg-yellow text-inverse text-center rounded-corner"
                                           style="line-height: 30px"></i>
                                    </div>
                                    <div class="widget-chat-header-content">
                                        <h4 class="widget-chat-header-title">Write Comment To Author and Reviewer</h4>
                                    </div>
                                </div>
                                <!-- end widget-chat-header -->

                                <!-- begin widget-chat-body -->
                                <div class="widget-chat-body" data-scrollbar="true" data-height="250px"
                                     id="editor_chat_body">


                                </div>
                                <!-- end widget-chat-body -->
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <div class="col-lg-12 col-lg-6">
                            <br>
                            <div class="m-b-10 m-t-10 f-s-12">
                                <h5 class="text-inverse">Send to Reviewers. Minimum two Reviewers</h5>
                            </div>

                            <div class="jumbotron forshadow">
                                <div class="form-group row m-b-10 align-items-center">
                                    <label class="col-md-3 col-form-label"><h4>Choosing Types</h4></label>
                                    <div class="col-md-9">
                                        <div class="form-check form-check-inline"
                                             style="border:5px solid white; padding:10px; border-radius:10px;">
                                            <input class="form-check-input" type="radio" name="radio_reviewer"
                                                   id="Radio1" value="1"
                                                   style="box-shadow:0 0 5px 0px gray inset; border-radius:50%; border:1px solid darkgray; width:20px; height:20px; outline:none;"/>
                                            <label class="form-check-label" for="defaultInlineRadio1">Choose
                                                Reviewer</label>
                                        </div>
                                        <div class="form-check form-check-inline"
                                             style="border:5px solid white; padding:10px; border-radius:10px;">
                                            <input class="form-check-input" type="radio" name="radio_reviewer"
                                                   id="Radio2" value="2"
                                                   style="box-shadow:0 0 5px 0px gray inset; border-radius:50%; border:1px solid darkgray; width:20px; height:20px; outline:none;"/>
                                            <label class="form-check-label" for="defaultInlineRadio2">Random
                                                Choosing</label>
                                        </div>
                                    </div>
                                </div>
                                <br>

                                <form method="post" id="choose_reviewer_form">
                                    {% csrf_token %}
                                    <div class="widget-todolist widget-todolist-rounded m-b-30" data-id="widget"
                                         id="list_reviewers" style="display: none;">
                                        <!-- begin widget-todolist-header -->
                                        <div class="widget-todolist-header">
                                            <div class="widget-todolist-header-left">
                                                <h4 class="widget-todolist-header-title">Reviewers</h4>
                                            </div>
                                            <div class="widget-todolist-header-right">
                                                <div class="widget-todolist-header-total" id="count_reviewer"></div>
                                            </div>
                                        </div>
                                        <!-- end widget-todolist-header -->
                                        <!-- begin widget-todolist-body -->
                                        <div class="widget-todolist-body" id="widget-todolist-body">


                                        </div>
                                        <!-- end widget-todolist-body -->
                                        <div class="widget-todolist-item">
                                            <div class="widget-todolist-input">
                                                <button type="button" data-id="{{ article.id }}" class="btn btn-success"
                                                        id="send_btn_to_reviewer"
                                                        {% if article.article_status.id != 1 or article.is_resubmit %}
                                                        disabled {% endif %}
                                                >
                                                    SEND TO SELECTED REVIEWERS
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="container" id="random_btn" style="display: none;">
                                        <label>Choose number of reviewers
                                            <input type="number" id="reviewer_number" name="reviewer_number" value="1"
                                                    {% if article.article_status.id != 1 or article.is_resubmit %}
                                                   disabled {% endif %}
                                                   class="form-control">
                                        </label>
                                        <button class="btn btn-md btn-info" id="random_send_reviewer_btn" type="button"
                                                data-id="{{ article.id }}" data-action="{{ csrf_token }}"
                                                {% if article.article_status.id != 1 or article.is_resubmit %}
                                                disabled {% endif %}>Generate
                                            Random Choosing Reviewers
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12 col-lg-6">
                        <div class="m-b-10 m-t-10 f-s-12">
                            <h5 class="text-inverse">Reviewing Process</h5>
                        </div>
                        <form method="post">
                            {% csrf_token %}
                            <button style="width:100%;" data-id="{{ article.id }},{{ notif_id }},0"
                                    data-action="{{ csrf_token }}"
                                    class="btn btn-sm btn-success forshadow resultBtn"
                                    id="approveForPublicationBtn"
                                    {% if article.article_status.id != 5 %} disabled {% endif %}
                                    {% if not is_ready_publish %} disabled {% endif %}>
                                TASDIQLASH
                            </button>
                            <br>
                            <br>
                            <button style="width:100%;" data-id="{{ article.id }},{{ notif_id }},1"
                                    data-action="{{ csrf_token }}"
                                    class="btn btn-sm btn-danger forshadow resultBtn"
                                    id="rejectedBtn"
                                    {% if article.article_status.id != 5 %} disabled {% endif %}
                                    {% if not is_ready_rejected %} disabled {% endif %}
                            >
                                RAD ETISH
                            </button>
                            <br>
                            <br>
                            <button style="width:100%;" data-id="{{ article.id }},{{ notif_id }},2"
                                    data-action="{{ csrf_token }}"
                                    class="btn btn-sm btn-primary forshadow resultBtn"
                                    id="resubmitBtn"
                                    {% if article.article_status.id != 5 %} disabled {% endif %}
                                    {% if not is_ready_resubmit %} disabled {% endif %}>
                                MUALLIFGA QAYTA YUBORISH
                            </button>
                            <p></p>
                            {% if is_ready_resubmit %}
                                <textarea id="resubmit_text" class="form-control"
                                          placeholder="Muallifga qayta yuborish sababini yozing..."></textarea>
                            {% endif %}
                        <br>
                            <button style="width:100%;" data-id="{{ article.id }},{{ notif_id }},3"
                                    data-action="{{ csrf_token }}"
                                    class="btn btn-sm btn-info forshadow resultBtn"
                                    id="rejectedExtraReviewerBtn"
                                    {% if article.article_status.id != 5 %} disabled {% endif %}
                                    {% if not is_ready_resubmit_extra_reviewer %} disabled {% endif %}
                            >
                                BOSHQA TAQRIZCHIGA MAQOLANI YUBORISH
                            </button>
                        </form>
                        <br>
                        <br>
                        {% for item in article_reviews %}
                            <div class="card forshadow" style="padding: 1%;">
                                <table>
                                    <tr>
                                        <div class="progress">
                                            {% if item.status.id == 1 %}
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                                                     role="progressbar" style="width: 25%" aria-valuenow="25"
                                                     aria-valuemin="0" aria-valuemax="100">Yuborilgan
                                                </div>
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                                                     role="progressbar" style="width: 0%" aria-valuenow="0"
                                                     aria-valuemin="0" aria-valuemax="100">Ko'rilmoqda
                                                </div>
                                                <div class="progress-bar progress-bar-striped bg-success"
                                                     role="progressbar" style="width: 0%" aria-valuenow="0"
                                                     aria-valuemin="0" aria-valuemax="100">Tugatildi
                                                </div>
                                            {% endif %}
                                            {% if item.status.id == 2 %}
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                                                     role="progressbar" style="width: 25%" aria-valuenow="25"
                                                     aria-valuemin="0" aria-valuemax="100">Yuborilgan
                                                </div>
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                                                     role="progressbar" style="width: 35%" aria-valuenow="35"
                                                     aria-valuemin="0" aria-valuemax="100">Ko'rilmoqda
                                                </div>
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                                     role="progressbar" style="width: 0%" aria-valuenow="0"
                                                     aria-valuemin="0" aria-valuemax="100">Tugatildi
                                                </div>
                                            {% endif %}
                                            {% if item.status.id == 3 or item.status.id == 4 %}
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                                                     role="progressbar" style="width: 25%" aria-valuenow="25"
                                                     aria-valuemin="0" aria-valuemax="100">Yuborilgan
                                                </div>
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                                                     role="progressbar" style="width: 35%" aria-valuenow="35"
                                                     aria-valuemin="0" aria-valuemax="100">Ko'rilmoqda
                                                </div>
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                                     role="progressbar" style="width: 40%" aria-valuenow="40"
                                                     aria-valuemin="0" aria-valuemax="100">Tugatildi
                                                </div>
                                            {% endif %}
                                            {% if item.status.id == 5 %}
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                                                     role="progressbar" style="width: 25%" aria-valuenow="25"
                                                     aria-valuemin="0" aria-valuemax="100">Yuborilgan
                                                </div>
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                                                     role="progressbar" style="width: 25%" aria-valuenow="25"
                                                     aria-valuemin="0" aria-valuemax="100">Ko'rilmoqda
                                                </div>
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger"
                                                     role="progressbar" style="width: 25%" aria-valuenow="25"
                                                     aria-valuemin="0" aria-valuemax="100">Qayta yuborish
                                                </div>
                                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                                     role="progressbar" style="width: 0%" aria-valuenow="0"
                                                     aria-valuemin="0" aria-valuemax="100">Tugatildi
                                                </div>
                                            {% endif %}
                                        </div>
                                        <br>
                                    </tr>
                                    <tr>
                                        <td><h3>{{ forloop.counter }}</h3></td>
                                        <td><b>Reviewer: </b> {{ item.reviewer.user.full_name }}</td>
                                        <td><b>Status: </b>
                                            <span {% if item.status.id == 1 %}
                                                class='badge badge-warning' {% elif item.status.id == 2 %}
                                                class='badge badge-info' {% elif item.status.id == 3 %}
                                                class='badge badge-success' {% elif item.status.id == 4 %}
                                                class='badge badge-danger' {% elif item.status.id == 5 %}
                                                class='badge badge-indigo' {% endif %}>
                                                    {{ item.status.name }}
                                                </span>
                                        </td>
                                        <td><b>Created Time: </b>{% if item.created_at %}{{ item.created_at }}{% else %}
                                            Not yet {% endif %}</td>
                                        <td><b>Updated Time: </b>{% if item.updated_at %}{{ item.updated_at }}{% else %}
                                            Not yet {% endif %}</td>
                                        <td>
                                            {% if item.status.id == 5 and article.article_status.id == 1 %}
                                                <form method="post">
                                                    {% csrf_token %}
                                                    <button type="button" data-id="{{ item.id }}"
                                                            id="resubmit_to_reviewer_btn_{{ item.id }}"
                                                            data-action="{{ csrf_token }}"
                                                            class="btn btn-outline-success btn-xs resubmit_to_reviewer_btn">
                                                        <i class="fas fa-lg fa-fw m-r-10 fa-arrow-circle-right"></i>Qayta
                                                        yuborish
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </td>
                                        <td>{% if item.status.id == 3 %}<i class="fas fa-lg fa-fw m-r-10 fa-check"
                                                                           style="color: lightgreen; font-size: 18px;"></i>{% else %}
                                            <i class="fas fa-lg fa-fw m-r-10 fa-times"
                                               style="color: pink; font-size: 18px;"></i>{% endif %}</td>
                                    </tr>
                                </table>
                                <table>
                                    <tr>
                                        <br><b>Taqriz bayoni: </b> {% if item.comment %}{{ item.comment }}{% else %}
                                        <em>No message</em> {% endif %}
                                    </tr>
                                </table>
                            </div>
                            <br>
                        {% endfor %}
                        <br>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="writeeditor_message_div"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
        $('body').on('click', '.resubmit_to_reviewer_btn', function (e) {
            e.preventDefault();

            let id = $(this).data('id');
            let token = $(this).data('action');

            $.ajax({
                type: "POST",
                url: "/profile/editor_resubmit_to_reviewer/",
                data: {
                    review_id: id,
                    csrfmiddlewaretoken: token,
                },
                success: function (response) {
                    $('#resubmit_to_reviewer_btn_' + id).prop("disabled", true);
                    swal({
                        title: response.message,
                        timer: 1500,
                    });

                },
                error: function (error) {
                    console.log(error);
                }
            });

        });

        $('body').on('click', '.resultBtn', function (e) {
            e.preventDefault();
            let data = $(this).data('id');
            let article_id = parseInt(data.split(',')[0]);
            let notif_id = parseInt(data.split(',')[1]);
            let btn_number = parseInt(data.split(',')[2]);
            let token = $(this).data('action');

            if (btn_number === 2) {
                let text = $('#resubmit_text').val();
                if (text.length > 0) {
                    $.ajax({
                        type: "POST",
                        url: "/profile/approve_publish/",
                        data: {
                            article_id: article_id,
                            notif_id: notif_id,
                            text: text,
                            btn_number: btn_number,
                            csrfmiddlewaretoken: token,
                        },
                        success: function (response) {
                            $('#approveForPublicationBtn').prop("disabled", true);

                            swal({
                                title: response.message,
                                timer: 1500,
                            });

                            window.location.reload();
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });

                } else {
                    alert("Izohni kiriting!");
                }
            }

            if (btn_number === 0 || btn_number === 1 || btn_number === 3) {
                $.ajax({
                    type: "POST",
                    url: "/profile/approve_publish/",
                    data: {
                        article_id: article_id,
                        notif_id: notif_id,
                        btn_number: btn_number,
                        csrfmiddlewaretoken: token,
                    },
                    success: function (response) {
                        $('#approveForPublicationBtn').prop("disabled", true);

                        swal({
                            title: response.message,
                            timer: 1500,
                        });

                        window.location.reload();
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            }

        });

        $('body').on('click', '#random_send_reviewer_btn', function (e) {
            e.preventDefault();

            let id = $(this).data('id');
            let token = $(this).data('action');

            let value = $('#reviewer_number').val();

            if (value > 0) {
                $.ajax({
                    type: "POST",
                    url: "/profile/random_sending_reviewer/",
                    data: {
                        value: value,
                        article_id: id,
                        csrfmiddlewaretoken: token,
                    },
                    success: function (response) {
                        if (response.is_valid) {
                            $('#send_btn_to_reviewer').prop("disabled", true);
                            $('#random_send_reviewer_btn').prop("disabled", true);
                            swal({
                                title: response.message,
                                timer: 1500,
                            });
                            window.location.reload();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            } else {
                alert("Taqrizchilar sonini kiriting!")
            }
        });

        $('body').on('click', '#send_btn_to_reviewer', function (e) {
            e.preventDefault();

            let article_id = $(this).data('id');

            let selected = [];
            $('#widget-todolist-body input[type=checkbox]').each(function () {
                if ($(this).is(":checked")) {
                    selected.push($(this).val());
                }
            });

            let n = selected.length;

            if (n === 0) {
                alert("Taqrizchi tanlamadiz!");
            }

            if (n > 5) {
                alert("5 tadan kop Taqrizchi tanladiz");
            }

            if (n >= 1 && n <= 5) {
                $.ajax({
                    type: "POST",
                    url: "/profile/sending_reviewer/",
                    data: {
                        reviewers: selected,
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        article_id:{{ article.id }}
                    },
                    success: function (response) {
                        if (response.is_valid) {
                            $('#send_btn_to_reviewer').prop("disabled", true);
                            $('#random_btn').prop("disabled", true);

                            swal({
                                title: response.message,
                                timer: 1500,
                            });
                            window.location.reload();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    }

                });
            }

        });

        $('input:radio[name="radio_reviewer"]').change(function () {

            if ($(this).val() == '1') {
                $('#list_reviewers').css("display", "block");
                $('#random_btn').css("display", "none");

                $.ajax({
                    type: 'GET',
                    url: "/profile/load_reviewers/",
                    success: function (response) {
                        $('#widget-todolist-body').empty();
                        $('#count_reviewer').html("<span>" + response.reviewers.length + "</span><small>Count</small>");


                        for (let item of response.reviewers) {
                            let widget_item = `<div class="widget-todolist-item">` +
                                `<div class="widget-todolist-input"><div class="checkbox checkbox-css pt-0">` +
                                `<input type="checkbox" id="widget_todolist_${item.id}" name="reviewer_checkbox" value="${item.id}"/><label for="widget_todolist_${item.id}" class="p-l-15">&nbsp;</label></div></div>` +
                                `<div class="widget-todolist-content"><h4 class="widget-todolist-title">` + item.user__last_name + " " + item.user__first_name + " " + item.user__middle_name +
                                `</h4><p class="widget-todolist-desc"><b>Email:</b>${item.user__email}</p></div><div class="widget-todolist-icon"><p class="widget-todolist-desc">${item.scientific_degree__name}</p></div><div class="widget-todolist-icon">
											<a href="#"><i class="fa fa-question-circle"></i></a></div>`
                                + `</div>`;

                            $('#widget-todolist-body').append(widget_item);
                        }
                    },
                    error: function (error) {
                        console.log("Xatolik");
                        console.log(error);
                    }
                });
            }

            if ($(this).val() == '2') {
                $('#list_reviewers').css("display", "none");
                $('#random_btn').css("display", "block");
            }

        });


        $('body').on('click', '#view-article-messages', function (e) {
            e.preventDefault();

            let id = $(this).data('id');

            $.ajax({
                type: "GET",
                url: "/profile/article_notification/view/" + id + "/",
                success: function (response) {
                    console.log(response);
                    $('#MessageBoxEditor').css('display', 'block');
                    $('#editor_chat_body').empty();

                    for (let item of response.notifications) {

                        let time_tz = new Date(item.created_at);
                        let time_string = time_tz.toLocaleString();
                        console.log(time_string);

                        if (response.current_user_id === item.from_user__id) {

                            let temp1 = `<div class="widget-chat-item right"><div class="widget-chat-info"><div class="widget-chat-info-container">
                                        <div class="widget-chat-name text-indigo">`
                                + item.from_user__email +
                                `</div><div class="widget-chat-message">`
                                + item.message +
                                `</div><div class="widget-chat-time">`
                                + `</div></div></div></div>`;

                            $('#editor_chat_body').append(temp1);
                        }

                        if (response.current_user_id === item.to_user__id) {
                            console.log("menga");

                            let temp2 = `<div class="widget-chat-item left">
                                        <div class="widget-chat-info">
                                            <div class="widget-chat-info-container">
                                        <div class="widget-chat-name text-indigo">`
                                + item.from_user__email +
                                `</div><div class="widget-chat-message">` + item.message + `</div>
                                             <div class="widget-chat-time">` + `</div>
                                             <br><div class="widget-chat-ansewer">
                                                <button type="button" data-id="${id},${item.from_user__id}" class="btn btn-white btn-sm editorWrite-message-btn">Ansewer</button>
                                            </div>
                                            </div></div></div>`;
                            $('#editor_chat_body').append(temp2);
                        }
                    }

                },
                error: function (response) {
                    console.log(response);
                }
            });

        });

        $('body').on('click', '.editorWrite-message-btn', function (e) {
            e.preventDefault();

            const data = $(this).data('id');
            const array = data.split(',');
            const id = array[0];
            const user_id = parseInt(array[1]);
            $.ajax({
                type: 'GET',
                url: "/send_message/" + id + "/" + user_id,
                success: function (response) {
                    $('#writeeditor_message_div').html(response);
                    $('#send-message-modal').modal('show');
                },
                error: function (error) {
                    console.log("Xatolik");
                    console.log(error);
                }
            });
        });
    </script>
{% endblock %}